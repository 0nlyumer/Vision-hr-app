<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vision HR & Payroll Suite</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom scrollbar for better look in Dark Mode */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="module">
        import React, { useState, useEffect, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';

        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Variables (Provided by Canvas Environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = firebaseConfig ? initializeApp(firebaseConfig) : null;
        const db = app ? getFirestore(app) : null;
        const auth = app ? getAuth(app) : null;

        // Utility Functions
        const generateUniqueId = () => Date.now().toString(36) + Math.random().toString(36).substring(2, 9);
        const formatCurrency = (amount) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
        const formatDate = (timestamp) => {
            if (!timestamp || !timestamp.toDate) return 'N/A';
            return timestamp.toDate().toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        };

        // --- START OF REACT COMPONENTS ---

        // Icon Component for easy use
        const Icon = ({ name, size = 20, className = '' }) => {
            if (typeof lucide === 'undefined') return <span className={className}>*</span>;
            const IconComponent = lucide[name];
            if (!IconComponent) return <span className={className}>?</span>;
            return <i dangerouslySetInnerHTML={{ __html: IconComponent.toSvg({ width: size, height: size, class: className }) }} />;
        };

        // Base Button Component
        const Button = ({ children, onClick, color = 'primary', icon, type = 'button', disabled = false, className = '' }) => {
            let baseStyle = 'px-4 py-2 rounded-lg font-semibold transition-all duration-200 shadow-lg flex items-center justify-center';
            let colorStyle = '';

            if (color === 'primary') {
                colorStyle = 'bg-blue-600 hover:bg-blue-700 text-white shadow-blue-500/50';
            } else if (color === 'danger') {
                colorStyle = 'bg-red-600 hover:bg-red-700 text-white shadow-red-500/50';
            } else if (color === 'secondary') {
                colorStyle = 'bg-gray-700 hover:bg-gray-600 text-gray-200 shadow-gray-700/50';
            } else if (color === 'success') {
                colorStyle = 'bg-green-600 hover:bg-green-700 text-white shadow-green-500/50';
            }

            if (disabled) {
                colorStyle = 'bg-gray-500 text-gray-300 cursor-not-allowed shadow-none';
            }

            return (
                <button type={type} onClick={onClick} className={`${baseStyle} ${colorStyle} ${className}`} disabled={disabled}>
                    {icon && <Icon name={icon} className="mr-2" size={20} />}
                    {children}
                </button>
            );
        };

        // Input Field Component
        const InputField = ({ label, id, type = 'text', value, onChange, placeholder = '', required = false, themeClass = '' }) => (
            <div className="mb-4">
                <label htmlFor={id} className={`block text-sm font-medium ${themeClass.text}`}>
                    {label} {required && <span className="text-red-500">*</span>}
                </label>
                <input
                    type={type}
                    id={id}
                    value={value || ''}
                    onChange={onChange}
                    placeholder={placeholder}
                    required={required}
                    className={`mt-1 block w-full px-3 py-2 border rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm ${themeClass.input}`}
                />
            </div>
        );

        // Select Field Component
        const SelectField = ({ label, id, value, onChange, options, required = false, themeClass = '' }) => (
            <div className="mb-4 relative">
                <label htmlFor={id} className={`block text-sm font-medium ${themeClass.text}`}>
                    {label} {required && <span className="text-red-500">*</span>}
                </label>
                <select
                    id={id}
                    value={value || ''}
                    onChange={onChange}
                    required={required}
                    className={`mt-1 block w-full pl-3 pr-10 py-2 border rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm ${themeClass.input} appearance-none`}
                >
                    <option value="" disabled>Select {label}</option>
                    {options.map(opt => (
                        <option key={opt.value} value={opt.value}>{opt.label}</option>
                    ))}
                </select>
                <Icon name="ChevronDown" size={16} className={`absolute right-3 top-1/2 -translate-y-1/2 mt-2 ${themeClass.text} pointer-events-none`} />
            </div>
        );

        // Card Component
        const Card = ({ children, className = '', themeClass = '' }) => (
            <div className={`p-6 rounded-xl shadow-2xl ${themeClass.card} ${className}`}>
                {children}
            </div>
        );

        // Tab Navigation Component
        const TabButton = ({ isActive, onClick, icon, children, themeClass }) => (
            <button
                onClick={onClick}
                className={`flex items-center space-x-2 px-4 py-2 rounded-lg transition-all duration-200 w-full ${
                    isActive
                        ? `${themeClass.tabActive} font-bold shadow-md`
                        : `${themeClass.tabInactive} hover:${themeClass.tabHover}`
                }`}
            >
                <Icon name={icon} size={20} />
                <span className="hidden sm:inline">{children}</span>
            </button>
        );

        // Confirmation/Alert Modal
        const Modal = ({ isOpen, title, children, onClose, themeClass, modalData }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-70 backdrop-blur-sm" onClick={onClose}>
                    <Card themeClass={themeClass} className="w-full max-w-md" onClick={(e) => e.stopPropagation()}>
                        <h3 className={`text-xl font-bold mb-4 ${themeClass.text}`}>{title}</h3>
                        <div className="mb-6">{children}</div>
                        {modalData.type !== 'ConfirmDelete' && (
                            <div className="flex justify-end">
                                <Button onClick={onClose} color="secondary">Close</Button>
                            </div>
                        )}
                        {modalData.type === 'ConfirmDelete' && (
                             <div className="mt-4 flex justify-end space-x-3">
                                <Button onClick={onClose} color="secondary">Cancel</Button>
                                <Button onClick={() => {
                                    modalData.data.onConfirm();
                                    onClose(); // Close modal after confirmation
                                }} color="danger">Delete</Button>
                            </div>
                        )}
                    </Card>
                </div>
            );
        };
        
        // --- MAIN APPLICATION COMPONENT ---
        const App = () => {
            const [userId, setUserId] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [employees, setEmployees] = useState([]);
            const [ledgers, setLedgers] = useState([]);
            const [attendance, setAttendance] = useState([]);
            const [activeTab, setActiveTab] = useState('Dashboard');
            const [modal, setModal] = useState({ isOpen: false, type: null, data: null });
            const [theme, setTheme] = useState('dark'); // Default to dark

            // --- Theme Definitions ---
            const themes = {
                dark: {
                    bg: 'bg-gray-900',
                    sidebar: 'bg-gray-800',
                    text: 'text-gray-100',
                    textSecondary: 'text-gray-400',
                    card: 'bg-gray-800 border border-gray-700',
                    input: 'bg-gray-700 border-gray-600 text-white',
                    tabActive: 'bg-blue-600 text-white',
                    tabInactive: 'text-gray-400',
                    tabHover: 'bg-gray-700',
                    accent: 'text-blue-400',
                },
                light: {
                    bg: 'bg-gray-100',
                    sidebar: 'bg-white',
                    text: 'text-gray-800',
                    textSecondary: 'text-gray-500',
                    card: 'bg-white shadow-xl',
                    input: 'bg-gray-50 border-gray-300 text-gray-800',
                    tabActive: 'bg-blue-500 text-white',
                    tabInactive: 'text-gray-600',
                    tabHover: 'bg-gray-200',
                    accent: 'text-blue-600',
                },
                ocean: {
                    bg: 'bg-blue-900',
                    sidebar: 'bg-blue-800',
                    text: 'text-blue-100',
                    textSecondary: 'text-blue-300',
                    card: 'bg-blue-800 border border-blue-700',
                    input: 'bg-blue-700 border-blue-600 text-white',
                    tabActive: 'bg-teal-500 text-white',
                    tabInactive: 'text-blue-200',
                    tabHover: 'bg-blue-700',
                    accent: 'text-teal-400',
                }
            };
            const themeClass = themes[theme] || themes.dark;

            // --- Firebase Auth & Setup ---
            useEffect(() => {
                if (!auth) {
                    console.error("Firebase Auth not initialized.");
                    setIsAuthReady(true);
                    return;
                }

                const setupAuth = async () => {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Auth Error:", error);
                    }
                };

                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    if (user) {
                        setUserId(user.uid);
                        setLogLevel('debug');
                    } else {
                        setUserId(crypto.randomUUID());
                    }
                    setIsAuthReady(true);
                });

                setupAuth();
                return () => unsubscribe();
            }, []);

            // --- Firestore Data Listeners ---
            useEffect(() => {
                if (!db || !userId || !isAuthReady) return;

                const baseCollectionPath = `/artifacts/${appId}/users/${userId}`;

                // Listener 1: Employees
                const employeeRef = collection(db, `${baseCollectionPath}/employees`);
                const unsubEmployees = onSnapshot(employeeRef, (snapshot) => {
                    setEmployees(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                }, (error) => console.error("Employee Snapshot Error:", error));

                // Listener 2: Ledgers
                const ledgerRef = collection(db, `${baseCollectionPath}/ledgers`);
                const unsubLedgers = onSnapshot(ledgerRef, (snapshot) => {
                    setLedgers(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                }, (error) => console.error("Ledger Snapshot Error:", error));

                // Listener 3: Attendance
                const attendanceRef = collection(db, `${baseCollectionPath}/attendance`);
                const unsubAttendance = onSnapshot(attendanceRef, (snapshot) => {
                    setAttendance(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                }, (error) => console.error("Attendance Snapshot Error:", error));

                return () => {
                    unsubEmployees();
                    unsubLedgers();
                    unsubAttendance();
                };
            }, [isAuthReady, userId, db]);

            // --- CRUD Operations ---
            const saveDocument = useCallback(async (collectionName, data, id = null) => {
                if (!db || !userId) {
                    setModal({ isOpen: true, type: 'Error', data: { message: 'Authentication required for saving data.' } });
                    return false;
                }
                const collectionPath = `/artifacts/${appId}/users/${userId}/${collectionName}`;
                try {
                    if (id) {
                        await setDoc(doc(db, collectionPath, id), data, { merge: true });
                    } else {
                        await addDoc(collection(db, collectionPath), data);
                    }
                    return true;
                } catch (error) {
                    console.error(`Error saving document to ${collectionName}:`, error);
                    setModal({ isOpen: true, type: 'Error', data: { message: `Failed to save ${collectionName} data: ${error.message}` } });
                    return false;
                }
            }, [db, userId]);

            const deleteDocument = useCallback(async (collectionName, id) => {
                if (!db || !userId) {
                    setModal({ isOpen: true, type: 'Error', data: { message: 'Authentication required for deleting data.' } } );
                    return false;
                }
                const collectionPath = `/artifacts/${appId}/users/${userId}/${collectionName}`;
                try {
                    await deleteDoc(doc(db, collectionPath, id));
                    return true;
                } catch (error) {
                    console.error(`Error deleting document from ${collectionName}:`, error);
                    setModal({ isOpen: true, type: 'Error', data: { message: `Failed to delete ${collectionName} data: ${error.message}` } });
                    return false;
                }
            }, [db, userId]);

            // --- Employee Management Component ---
            const EmployeeManagement = () => {
                const [formData, setFormData] = useState({});
                const [isEditing, setIsEditing] = useState(false);
                const [searchTerm, setSearchTerm] = useState('');

                const handleChange = (e) => {
                    setFormData({ ...formData, [e.target.id]: e.target.value });
                };

                const handleSubmit = async (e) => {
                    e.preventDefault();
                    const success = await saveDocument('employees', {
                        ...formData,
                        salary: parseFloat(formData.salary || 0),
                        dateJoined: new Date(),
                    }, isEditing ? formData.id : null);

                    if (success) {
                        setFormData({});
                        setIsEditing(false);
                        setModal({ isOpen: true, type: 'Success', data: { message: `Employee ${isEditing ? 'updated' : 'added'} successfully in Vision.` } });
                    }
                };

                const handleEdit = (employee) => {
                    setFormData(employee);
                    setIsEditing(true);
                };

                const handleDelete = async (id) => {
                    setModal({
                        isOpen: true,
                        type: 'ConfirmDelete',
                        data: {
                            message: "Are you sure you want to delete this employee? This action cannot be undone.",
                            onConfirm: async () => {
                                const success = await deleteDocument('employees', id);
                                if (success) {
                                    setModal({ isOpen: true, type: 'Success', data: { message: 'Employee deleted successfully.' } });
                                } else {
                                    setModal({ isOpen: true, type: 'Error', data: { message: 'Failed to delete employee.' } });
                                }
                            }
                        }
                    });
                };

                const filteredEmployees = employees.filter(emp =>
                    emp.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    emp.role.toLowerCase().includes(searchTerm.toLowerCase())
                ).sort((a, b) => new Date(b.dateJoined) - new Date(a.dateJoined));

                const employeeRoles = [
                    { value: 'Manager', label: 'Manager' },
                    { value: 'Developer', label: 'Developer' },
                    { value: 'HR', label: 'HR Specialist' },
                    { value: 'Sales', label: 'Sales Representative' },
                    { value: 'Other', label: 'Other' },
                ];

                return (
                    <div className="space-y-6">
                        <Card themeClass={themeClass}>
                            <h2 className={`text-2xl font-bold mb-4 ${themeClass.accent}`}>{isEditing ? 'Edit Employee' : 'Add New Employee'}</h2>
                            <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <InputField label="Full Name" id="name" value={formData.name} onChange={handleChange} required themeClass={themeClass} />
                                <SelectField label="Role" id="role" value={formData.role} onChange={handleChange} options={employeeRoles} required themeClass={themeClass} />
                                <InputField label="Email" id="email" type="email" value={formData.email} onChange={handleChange} themeClass={themeClass} />
                                <InputField label="Monthly Salary (USD)" id="salary" type="number" value={formData.salary} 

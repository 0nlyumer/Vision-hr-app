<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vision HR & Payroll Suite</title>
    <!-- Tailwind CSS CDN -->
    <script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)"></script>
    <!-- Lucide Icons CDN -->
    <script src="[https://unpkg.com/lucide@latest](https://unpkg.com/lucide@latest)"></script>
    <style>
        /* Custom scrollbar for better look in Dark Mode */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="module">
        import React, { useState, useEffect, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';

        // Firebase Imports
        import { initializeApp } from "[https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js](https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js)";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "[https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js](https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js)";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, addDoc, updateDoc, deleteDoc } from "[https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js](https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js)";
        import { setLogLevel } from "[https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js](https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js)";

        // Global Variables (Provided by Canvas Environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = firebaseConfig ? initializeApp(firebaseConfig) : null;
        const db = app ? getFirestore(app) : null;
        const auth = app ? getAuth(app) : null;

        // Utility Functions
        const generateUniqueId = () => Date.now().toString(36) + Math.random().toString(36).substring(2, 9);
        const formatCurrency = (amount) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
        const formatDate = (timestamp) => {
            if (!timestamp || !timestamp.toDate) return 'N/A';
            return timestamp.toDate().toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        };

        // --- START OF REACT COMPONENTS ---

        // Icon Component for easy use
        const Icon = ({ name, size = 20, className = '' }) => {
            if (typeof lucide === 'undefined') return <span className={className}>*</span>;
            const IconComponent = lucide[name];
            if (!IconComponent) return <span className={className}>?</span>;
            return <i dangerouslySetInnerHTML={{ __html: IconComponent.toSvg({ width: size, height: size, class: className }) }} />;
        };

        // Base Button Component
        const Button = ({ children, onClick, color = 'primary', icon, type = 'button', disabled = false, className = '' }) => {
            let baseStyle = 'px-4 py-2 rounded-lg font-semibold transition-all duration-200 shadow-lg flex items-center justify-center';
            let colorStyle = '';

            if (color === 'primary') {
                colorStyle = 'bg-blue-600 hover:bg-blue-700 text-white shadow-blue-500/50';
            } else if (color === 'danger') {
                colorStyle = 'bg-red-600 hover:bg-red-700 text-white shadow-red-500/50';
            } else if (color === 'secondary') {
                colorStyle = 'bg-gray-700 hover:bg-gray-600 text-gray-200 shadow-gray-700/50';
            } else if (color === 'success') {
                colorStyle = 'bg-green-600 hover:bg-green-700 text-white shadow-green-500/50';
            }

            if (disabled) {
                colorStyle = 'bg-gray-500 text-gray-300 cursor-not-allowed shadow-none';
            }

            return (
                <button type={type} onClick={onClick} className={`${baseStyle} ${colorStyle} ${className}`} disabled={disabled}>
                    {icon && <Icon name={icon} className="mr-2" size={20} />}
                    {children}
                </button>
            );
        };

        // Input Field Component
        const InputField = ({ label, id, type = 'text', value, onChange, placeholder = '', required = false, themeClass = '' }) => (
            <div className="mb-4">
                <label htmlFor={id} className={`block text-sm font-medium ${themeClass.text}`}>
                    {label} {required && <span className="text-red-500">*</span>}
                </label>
                <input
                    type={type}
                    id={id}
                    value={value || ''}
                    onChange={onChange}
                    placeholder={placeholder}
                    required={required}
                    className={`mt-1 block w-full px-3 py-2 border rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm ${themeClass.input}`}
                />
            </div>
        );

        // Select Field Component
        const SelectField = ({ label, id, value, onChange, options, required = false, themeClass = '' }) => (
            <div className="mb-4 relative">
                <label htmlFor={id} className={`block text-sm font-medium ${themeClass.text}`}>
                    {label} {required && <span className="text-red-500">*</span>}
                </label>
                <select
                    id={id}
                    value={value || ''}
                    onChange={onChange}
                    required={required}
                    className={`mt-1 block w-full pl-3 pr-10 py-2 border rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm ${themeClass.input} appearance-none`}
                >
                    <option value="" disabled>Select {label}</option>
                    {options.map(opt => (
                        <option key={opt.value} value={opt.value}>{opt.label}</option>
                    ))}
                </select>
                <Icon name="ChevronDown" size={16} className={`absolute right-3 top-1/2 -translate-y-1/2 mt-2 ${themeClass.text} pointer-events-none`} />
            </div>
        );

        // Card Component
        const Card = ({ children, className = '', themeClass = '' }) => (
            <div className={`p-6 rounded-xl shadow-2xl ${themeClass.card} ${className}`}>
                {children}
            </div>
        );

        // Tab Navigation Component
        const TabButton = ({ isActive, onClick, icon, children, themeClass }) => (
            <button
                onClick={onClick}
                className={`flex items-center space-x-2 px-4 py-2 rounded-lg transition-all duration-200 w-full ${
                    isActive
                        ? `${themeClass.tabActive} font-bold shadow-md`
                        : `${themeClass.tabInactive} hover:${themeClass.tabHover}`
                }`}
            >
                <Icon name={icon} size={20} />
                <span className="hidden sm:inline">{children}</span>
            </button>
        );

        // Confirmation/Alert Modal
        const Modal = ({ isOpen, title, children, onClose, themeClass, modalData }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-70 backdrop-blur-sm" onClick={onClose}>
                    <Card themeClass={themeClass} className="w-full max-w-md" onClick={(e) => e.stopPropagation()}>
                        <h3 className={`text-xl font-bold mb-4 ${themeClass.text}`}>{title}</h3>
                        <div className="mb-6">{children}</div>
                        {modalData.type !== 'ConfirmDelete' && (
                            <div className="flex justify-end">
                                <Button onClick={onClose} color="secondary">Close</Button>
                            </div>
                        )}
                        {modalData.type === 'ConfirmDelete' && (
                             <div className="mt-4 flex justify-end space-x-3">
                                <Button onClick={onClose} color="secondary">Cancel</Button>
                                <Button onClick={() => {
                                    modalData.data.onConfirm();
                                    onClose(); // Close modal after confirmation
                                }} color="danger">Delete</Button>
                            </div>
                        )}
                    </Card>
                </div>
            );
        };
        
        // --- MAIN APPLICATION COMPONENT ---
        const App = () => {
            const [userId, setUserId] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [employees, setEmployees] = useState([]);
            const [ledgers, setLedgers] = useState([]);
            const [attendance, setAttendance] = useState([]);
            const [activeTab, setActiveTab] = useState('Dashboard');
            const [modal, setModal] = useState({ isOpen: false, type: null, data: null });
            const [theme, setTheme] = useState('dark'); // Default to dark

            // --- Theme Definitions ---
            const themes = {
                dark: {
                    bg: 'bg-gray-900',
                    sidebar: 'bg-gray-800',
                    text: 'text-gray-100',
                    textSecondary: 'text-gray-400',
                    card: 'bg-gray-800 border border-gray-700',
                    input: 'bg-gray-700 border-gray-600 text-white',
                    tabActive: 'bg-blue-600 text-white',
                    tabInactive: 'text-gray-400',
                    tabHover: 'bg-gray-700',
                    accent: 'text-blue-400',
                },
                light: {
                    bg: 'bg-gray-100',
                    sidebar: 'bg-white',
                    text: 'text-gray-800',
                    textSecondary: 'text-gray-500',
                    card: 'bg-white shadow-xl',
                    input: 'bg-gray-50 border-gray-300 text-gray-800',
                    tabActive: 'bg-blue-500 text-white',
                    tabInactive: 'text-gray-600',
                    tabHover: 'bg-gray-200',
                    accent: 'text-blue-600',
                },
                ocean: {
                    bg: 'bg-blue-900',
                    sidebar: 'bg-blue-800',
                    text: 'text-blue-100',
                    textSecondary: 'text-blue-300',
                    card: 'bg-blue-800 border border-blue-700',
                    input: 'bg-blue-700 border-blue-600 text-white',
                    tabActive: 'bg-teal-500 text-white',
                    tabInactive: 'text-blue-200',
                    tabHover: 'bg-blue-700',
                    accent: 'text-teal-400',
                }
            };
            const themeClass = themes[theme] || themes.dark;

            // --- Firebase Auth & Setup ---
            useEffect(() => {
                if (!auth) {
                    console.error("Firebase Auth not initialized.");
                    setIsAuthReady(true);
                    return;
                }

                const setupAuth = async () => {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Auth Error:", error);
                    }
                };

                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    if (user) {
                        setUserId(user.uid);
                        setLogLevel('debug');
                    } else {
                        setUserId(crypto.randomUUID());
                    }
                    setIsAuthReady(true);
                });

                setupAuth();
                return () => unsubscribe();
            }, []);

            // --- Firestore Data Listeners ---
            useEffect(() => {
                if (!db || !userId || !isAuthReady) return;

                const baseCollectionPath = `/artifacts/${appId}/users/${userId}`;

                // Listener 1: Employees
                const employeeRef = collection(db, `${baseCollectionPath}/employees`);
                const unsubEmployees = onSnapshot(employeeRef, (snapshot) => {
                    setEmployees(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                }, (error) => console.error("Employee Snapshot Error:", error));

                // Listener 2: Ledgers
                const ledgerRef = collection(db, `${baseCollectionPath}/ledgers`);
                const unsubLedgers = onSnapshot(ledgerRef, (snapshot) => {
                    setLedgers(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                }, (error) => console.error("Ledger Snapshot Error:", error));

                // Listener 3: Attendance
                const attendanceRef = collection(db, `${baseCollectionPath}/attendance`);
                const unsubAttendance = onSnapshot(attendanceRef, (snapshot) => {
                    setAttendance(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                }, (error) => console.error("Attendance Snapshot Error:", error));

                return () => {
                    unsubEmployees();
                    unsubLedgers();
                    unsubAttendance();
                };
            }, [isAuthReady, userId, db]);

            // --- CRUD Operations ---
            const saveDocument = useCallback(async (collectionName, data, id = null) => {
                if (!db || !userId) {
                    setModal({ isOpen: true, type: 'Error', data: { message: 'Authentication required for saving data.' } });
                    return false;
                }
                const collectionPath = `/artifacts/${appId}/users/${userId}/${collectionName}`;
                try {
                    if (id) {
                        await setDoc(doc(db, collectionPath, id), data, { merge: true });
                    } else {
                        await addDoc(collection(db, collectionPath), data);
                    }
                    return true;
                } catch (error) {
                    console.error(`Error saving document to ${collectionName}:`, error);
                    setModal({ isOpen: true, type: 'Error', data: { message: `Failed to save ${collectionName} data: ${error.message}` } });
                    return false;
                }
            }, [db, userId]);

            const deleteDocument = useCallback(async (collectionName, id) => {
                if (!db || !userId) {
                    setModal({ isOpen: true, type: 'Error', data: { message: 'Authentication required for deleting data.' } } );
                    return false;
                }
                const collectionPath = `/artifacts/${appId}/users/${userId}/${collectionName}`;
                try {
                    await deleteDoc(doc(db, collectionPath, id));
                    return true;
                } catch (error) {
                    console.error(`Error deleting document from ${collectionName}:`, error);
                    setModal({ isOpen: true, type: 'Error', data: { message: `Failed to delete ${collectionName} data: ${error.message}` } });
                    return false;
                }
            }, [db, userId]);

            // --- Employee Management Component ---
            const EmployeeManagement = () => {
                const [formData, setFormData] = useState({});
                const [isEditing, setIsEditing] = useState(false);
                const [searchTerm, setSearchTerm] = useState('');

                const handleChange = (e) => {
                    setFormData({ ...formData, [e.target.id]: e.target.value });
                };

                const handleSubmit = async (e) => {
                    e.preventDefault();
                    const success = await saveDocument('employees', {
                        ...formData,
                        salary: parseFloat(formData.salary || 0),
                        dateJoined: new Date(),
                    }, isEditing ? formData.id : null);

                    if (success) {
                        setFormData({});
                        setIsEditing(false);
                        setModal({ isOpen: true, type: 'Success', data: { message: `Employee ${isEditing ? 'updated' : 'added'} successfully in Vision.` } });
                    }
                };

                const handleEdit = (employee) => {
                    setFormData(employee);
                    setIsEditing(true);
                };

                const handleDelete = async (id) => {
                    setModal({
                        isOpen: true,
                        type: 'ConfirmDelete',
                        data: {
                            message: "Are you sure you want to delete this employee? This action cannot be undone.",
                            onConfirm: async () => {
                                const success = await deleteDocument('employees', id);
                                if (success) {
                                    setModal({ isOpen: true, type: 'Success', data: { message: 'Employee deleted successfully.' } });
                                } else {
                                    setModal({ isOpen: true, type: 'Error', data: { message: 'Failed to delete employee.' } });
                                }
                            }
                        }
                    });
                };

                const filteredEmployees = employees.filter(emp =>
                    emp.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    emp.role.toLowerCase().includes(searchTerm.toLowerCase())
                ).sort((a, b) => new Date(b.dateJoined) - new Date(a.dateJoined));

                const employeeRoles = [
                    { value: 'Manager', label: 'Manager' },
                    { value: 'Developer', label: 'Developer' },
                    { value: 'HR', label: 'HR Specialist' },
                    { value: 'Sales', label: 'Sales Representative' },
                    { value: 'Other', label: 'Other' },
                ];

                return (
                    <div className="space-y-6">
                        <Card themeClass={themeClass}>
                            <h2 className={`text-2xl font-bold mb-4 ${themeClass.accent}`}>{isEditing ? 'Edit Employee' : 'Add New Employee'}</h2>
                            <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <InputField label="Full Name" id="name" value={formData.name} onChange={handleChange} required themeClass={themeClass} />
                                <SelectField label="Role" id="role" value={formData.role} onChange={handleChange} options={employeeRoles} required themeClass={themeClass} />
                                <InputField label="Email" id="email" type="email" value={formData.email} onChange={handleChange} themeClass={themeClass} />
                                <InputField label="Monthly Salary (USD)" id="salary" type="number" value={formData.salary} onChange={handleChange} required themeClass={themeClass} />
                                <div className="md:col-span-2 flex justify-end space-x-3">
                                    {isEditing && (
                                        <Button type="button" onClick={() => { setIsEditing(false); setFormData({}); }} color="secondary">
                                            Cancel Edit
                                        </Button>
                                    )}
                                    <Button type="submit" color="primary" icon={isEditing ? 'Save' : 'UserPlus'}>
                                        {isEditing ? 'Save Changes' : 'Add Employee'}
                                    </Button>
                                </div>
                            </form>
                        </Card>

                        <Card themeClass={themeClass}>
                            <h2 className={`text-2xl font-bold mb-4 ${themeClass.accent}`}>Employee Directory ({employees.length})</h2>
                            <InputField label="Search Employee" id="search" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} placeholder="Name or Role" themeClass={themeClass} />

                            <div className="overflow-x-auto mt-4">
                                <table className="min-w-full divide-y divide-gray-700">
                                    <thead>
                                        <tr className={`${themeClass.sidebar}`}>
                                            <th className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${themeClass.textSecondary}`}>Name</th>
                                            <th className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${themeClass.textSecondary}`}>Role</th>
                                            <th className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${themeClass.textSecondary}`}>Salary</th>
                                            <th className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${themeClass.textSecondary}`}>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody className={`divide-y divide-gray-700 ${themeClass.card}`}>
                                        {filteredEmployees.map((emp) => (
                                            <tr key={emp.id} className="hover:opacity-90 transition-opacity">
                                                <td className={`px-6 py-4 whitespace-nowrap ${themeClass.text}`}>{emp.name}</td>
                                                <td className={`px-6 py-4 whitespace-nowrap ${themeClass.textSecondary}`}>{emp.role}</td>
                                                <td className={`px-6 py-4 whitespace-nowrap font-semibold ${themeClass.accent}`}>{formatCurrency(emp.salary)}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                                    <Button onClick={() => handleEdit(emp)} color="secondary" icon="Edit" className="p-2" disabled={!isAuthReady}>Edit</Button>
                                                    <Button onClick={() => handleDelete(emp.id)} color="danger" icon="Trash2" className="p-2" disabled={!isAuthReady}>Delete</Button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                                {filteredEmployees.length === 0 && <p className={`text-center py-4 ${themeClass.textSecondary}`}>No employees found matching your search.</p>}
                            </div>
                        </Card>
                    </div>
                );
            };

            // --- Payroll/Ledger Component ---
            const LedgerManagement = () => {
                const [formData, setFormData] = useState({});
                const [searchTerm, setSearchTerm] = useState('');
                const [isEditing, setIsEditing] = useState(false);

                const handleLedgerChange = (e) => {
                    setFormData({ ...formData, [e.target.id]: e.target.value });
                };

                const handleLedgerSubmit = async (e) => {
                    e.preventDefault();
                    const employee = employees.find(emp => emp.id === formData.employeeId);

                    if (!employee && formData.type !== 'Expense') {
                        setModal({ isOpen: true, type: 'Error', data: { message: 'Please select a valid employee, or choose "Company Expense".' } });
                        return;
                    }

                    const success = await saveDocument('ledgers', {
                        ...formData,
                        amount: parseFloat(formData.amount || 0),
                        type: formData.type || 'Salary',
                        employeeName: employee ? employee.name : 'N/A (Expense)',
                        date: new Date(),
                    }, isEditing ? formData.id : null);

                    if (success) {
                        setFormData({});
                        setIsEditing(false);
                        setModal({ isOpen: true, type: 'Success', data: { message: `Ledger entry ${isEditing ? 'updated' : 'added'} successfully.` } });
                    }
                };

                const handleDelete = (id) => {
                    setModal({
                        isOpen: true,
                        type: 'ConfirmDelete',
                        data: {
                            message: "Confirm deletion of this ledger entry.",
                            onConfirm: async () => {
                                await deleteDocument('ledgers', id);
                                setModal({ isOpen: true, type: 'Success', data: { message: 'Ledger entry deleted.' } });
                            }
                        }
                    });
                };

                const filteredLedgers = ledgers.filter(ledger =>
                    ledger.employeeName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    ledger.type.toLowerCase().includes(searchTerm.toLowerCase())
                ).sort((a, b) => (b.date && a.date ? b.date.toDate() - a.date.toDate() : 0));

                const totalSalaryPaid = ledgers
                    .filter(l => l.type === 'Salary')
                    .reduce((sum, l) => sum + l.amount, 0);

                const totalBonusPaid = ledgers
                    .filter(l => l.type === 'Bonus')
                    .reduce((sum, l) => sum + l.amount, 0);

                return (
                    <div className="space-y-6">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <Card themeClass={themeClass} className="text-center">
                                <p className={themeClass.textSecondary}>Total Salaries Paid</p>
                                <h3 className={`text-3xl font-extrabold mt-1 ${themeClass.accent}`}>{formatCurrency(totalSalaryPaid)}</h3>
                            </Card>
                            <Card themeClass={themeClass} className="text-center">
                                <p className={themeClass.textSecondary}>Total Bonuses</p>
                                <h3 className={`text-3xl font-extrabold mt-1 ${themeClass.accent}`}>{formatCurrency(totalBonusPaid)}</h3>
                            </Card>
                            <Card themeClass={themeClass} className="text-center">
                                <p className={themeClass.textSecondary}>Total Employees</p>
                                <h3 className={`text-3xl font-extrabold mt-1 ${themeClass.accent}`}>{employees.length}</h3>
                            </Card>
                        </div>

                        <Card themeClass={themeClass}>
                            <h2 className={`text-2xl font-bold mb-4 ${themeClass.accent}`}>{isEditing ? 'Edit Ledger Entry' : 'New Payroll/Ledger Entry'}</h2>
                            <form onSubmit={handleLedgerSubmit} className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                 <SelectField
                                    label="Transaction Type"
                                    id="type"
                                    value={formData.type}
                                    onChange={handleLedgerChange}
                                    options={[
                                        { value: 'Salary', label: 'Salary Payment' },
                                        { value: 'Bonus', label: 'Bonus/Incentive' },
                                        { value: 'Expense', label: 'Company Expense' },
                                    ]}
                                    required
                                    themeClass={themeClass}
                                />
                                <SelectField
                                    label="Employee (Optional for Expense)"
                                    id="employeeId"
                                    value={formData.employeeId}
                                    onChange={handleLedgerChange}
                                    options={employees.map(emp => ({ value: emp.id, label: emp.name }))}
                                    required={formData.type !== 'Expense'}
                                    themeClass={themeClass}
                                />
                                <InputField label="Amount" id="amount" type="number" value={formData.amount} onChange={handleLedgerChange} required themeClass={themeClass} />

                                <div className="md:col-span-3 flex justify-end space-x-3">
                                    <Button type="submit" color="primary" icon={isEditing ? 'Save' : 'DollarSign'}>
                                        {isEditing ? 'Save Changes' : 'Record Payment'}
                                    </Button>
                                </div>
                            </form>
                        </Card>

                        <Card themeClass={themeClass}>
                            <h2 className={`text-2xl font-bold mb-4 ${themeClass.accent}`}>Ledger History</h2>
                            <InputField label="Search Ledger" id="search" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} placeholder="Employee Name or Type" themeClass={themeClass} />

                            <div className="overflow-x-auto mt-4">
                                <table className="min-w-full divide-y divide-gray-700">
                                    <thead>
                                        <tr className={`${themeClass.sidebar}`}>
                                            <th className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${themeClass.textSecondary}`}>Date</th>
                                            <th className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${themeClass.textSecondary}`}>Employee</th>
                                            <th className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${themeClass.textSecondary}`}>Type</th>
                                            <th className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${themeClass.textSecondary}`}>Amount</th>
                                            <th className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${themeClass.textSecondary}`}>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody className={`divide-y divide-gray-700 ${themeClass.card}`}>
                                        {filteredLedgers.map((ledger) => (
                                            <tr key={ledger.id} className="hover:opacity-90 transition-opacity">
                                                <td className={`px-6 py-4 whitespace-nowrap ${themeClass.text}`}>{formatDate(ledger.date)}</td>
                                                <td className={`px-6 py-4 whitespace-nowrap ${themeClass.text}`}>{ledger.employeeName}</td>
                                                <td className={`px-6 py-4 whitespace-nowrap ${themeClass.textSecondary}`}>{ledger.type}</td>
                                                <td className={`px-6 py-4 whitespace-nowrap font-semibold ${themeClass.accent}`}>{formatCurrency(ledger.amount)}</td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                                    <Button onClick={() => handleDelete(ledger.id)} color="danger" icon="Trash2" className="p-2" disabled={!isAuthReady}>Delete</Button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                                {filteredLedgers.length === 0 && <p className={`text-center py-4 ${themeClass.textSecondary}`}>No ledger entries found.</p>}
                            </div>
                        </Card>
                    </div>
                );
            };

            // --- Attendance Component ---
            const AttendanceManagement = () => {
                const [selectedEmployeeId, setSelectedEmployeeId] = useState('');
                const [isClockedIn, setIsClockedIn] = useState(false);
                const [searchTerm, setSearchTerm] = useState('');

                useEffect(() => {
                    if (selectedEmployeeId) {
                        const todayAttendance = attendance.filter(a =>
                            a.employeeId === selectedEmployeeId &&
                            a.date && a.date.toDate().toDateString() === new Date().toDateString()
                        );
                        const isCurrentlyIn = todayAttendance.some(a => a.timeIn && !a.timeOut);
                        setIsClockedIn(isCurrentlyIn);
                    }
                }, [attendance, selectedEmployeeId]);

                const handleClock = async () => {
                    if (!selectedEmployeeId) {
                        setModal({ isOpen: true, type: 'Error', data: { message: 'Please select an employee to clock in/out.' } });
                        return;
                    }

                    const employee = employees.find(emp => emp.id === selectedEmployeeId);
                    if (!employee) return;

                    if (isClockedIn) {
                        // Clock Out
                        const todayAttendance = attendance.filter(a =>
                            a.employeeId === selectedEmployeeId &&
                            a.date && a.date.toDate().toDateString() === new Date().toDateString() &&
                            !a.timeOut
                        ).sort((a, b) => b.date.toDate() - a.date.toDate()); // Get the latest clock-in

                        if (todayAttendance.length > 0) {
                            const latestEntry = todayAttendance[0];
                            await saveDocument('attendance', { timeOut: new Date() }, latestEntry.id);
                            setModal({ isOpen: true, type: 'Success', data: { message: `${employee.name} clocked OUT successfully.` } });
                        }
                    } else {
                        // Clock In
                        await saveDocument('attendance', {
                            employeeId: selectedEmployeeId,
                            employeeName: employee.name,
                            date: new Date(),
                            timeIn: new Date(),
                            timeOut: null,
                        });
                        setModal({ isOpen: true, type: 'Success', data: { message: `${employee.name} clocked IN successfully.` } });
                    }
                };

                const calculateHours = (inTime, outTime) => {
                    if (!inTime || !outTime) return 'N/A';
                    const diff = outTime.toDate().getTime() - inTime.toDate().getTime();
                    const hours = diff / (1000 * 60 * 60);
                    return hours.toFixed(2);
                };

                const filteredAttendance = attendance.filter(att =>
                    att.employeeName.toLowerCase().includes(searchTerm.toLowerCase())
                ).sort((a, b) => (b.date && a.date ? b.date.toDate() - a.date.toDate() : 0));

                return (
                    <div className="space-y-6">
                        <Card themeClass={themeClass}>
                            <h2 className={`text-2xl font-bold mb-4 ${themeClass.accent}`}>Clock In/Out</h2>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                <SelectField
                                    label="Select Employee"
                                    id="employeeSelect"
                                    value={selectedEmployeeId}
                                    onChange={(e) => setSelectedEmployeeId(e.target.value)}
                                    options={employees.map(emp => ({ value: emp.id, label: emp.name }))}
                                    required
                                    themeClass={themeClass}
                                />
                                <div className="md:col-span-2">
                                    <Button onClick={handleClock} color={isClockedIn ? 'danger' : 'success'} icon={isClockedIn ? 'LogOut' : 'LogIn'} disabled={!isAuthReady || !selectedEmployeeId} className="w-full">
                                        {isClockedIn ? 'Clock OUT' : 'Clock IN'}
                                    </Button>
                                </div>
                            </div>
                            {selectedEmployeeId && (
                                 <p className={`mt-3 text-center font-semibold ${isClockedIn ? 'text-red-400' : 'text-green-400'}`}>
                                    Current Status: {isClockedIn ? 'Clocked In' : 'Clocked Out'}
                                </p>
                            )}
                        </Card>

                        <Card themeClass={themeClass}>
                            <h2 className={`text-2xl font-bold mb-4 ${themeClass.accent}`}>Attendance Records</h2>
                            <InputField label="Search Records" id="search" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} placeholder="Employee Name" themeClass={themeClass} />

                            <div className="overflow-x-auto mt-4">
                                <table className="min-w-full divide-y divide-gray-700">
                                    <thead>
                                        <tr className={`${themeClass.sidebar}`}>
                                            <th className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${themeClass.textSecondary}`}>Date</th>
                                            <th className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${themeClass.textSecondary}`}>Employee</th>
                                            <th className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${themeClass.textSecondary}`}>Time In</th>
                                            <th className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${themeClass.textSecondary}`}>Time Out</th>
                                            <th className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${themeClass.textSecondary}`}>Hours</th>
                                        </tr>
                                    </thead>
                                    <tbody className={`divide-y divide-gray-700 ${themeClass.card}`}>
                                        {filteredAttendance.map((att) => (
                                            <tr key={att.id} className="hover:opacity-90 transition-opacity">
                                                <td className={`px-6 py-4 whitespace-nowrap ${themeClass.text}`}>{formatDate(att.date)}</td>
                                                <td className={`px-6 py-4 whitespace-nowrap ${themeClass.text}`}>{att.employeeName}</td>
                                                <td className={`px-6 py-4 whitespace-nowrap ${themeClass.textSecondary}`}>{att.timeIn ? att.timeIn.toDate().toLocaleTimeString('en-US') : 'N/A'}</td>
                                                <td className={`px-6 py-4 whitespace-nowrap ${att.timeOut ? themeClass.text : 'text-red-500'}`}>{att.timeOut ? att.timeOut.toDate().toLocaleTimeString('en-US') : 'Working'}</td>
                                                <td className={`px-6 py-4 whitespace-nowrap font-semibold ${themeClass.accent}`}>{calculateHours(att.timeIn, att.timeOut)}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                                {filteredAttendance.length === 0 && <p className={`text-center py-4 ${themeClass.textSecondary}`}>No attendance records found.</p>}
                            </div>
                        </Card>
                    </div>
                );
            };

            // --- Dashboard Component ---
            const Dashboard = () => {
                const totalEmployees = employees.length;
                const totalSalaries = employees.reduce((sum, emp) => sum + (emp.salary || 0), 0);
                const lastMonthSalaryPaid = ledgers.filter(l => l.type === 'Salary').reduce((sum, l) => sum + l.amount, 0);
                const activeEmployees = attendance.filter(a => a.timeIn && !a.timeOut).length;

                const StatCard = ({ title, value, icon, accentColor }) => (
                    <Card themeClass={themeClass} className={`text-center p-5 ${accentColor.bg} border-l-4 ${accentColor.border}`}>
                        <div className={`flex justify-center mb-2 ${accentColor.text}`}>
                            <Icon name={icon} size={30} />
                        </div>
                        <p className={`text-sm font-medium ${themeClass.textSecondary}`}>{title}</p>
                        <h3 className={`text-3xl font-extrabold mt-1 ${themeClass.text}`}>{value}</h3>
                    </Card>
                );

                return (
                    <div className="space-y-6">
                        <h1 className={`text-3xl font-bold mb-6 ${themeClass.accent}`}>Vision HR Dashboard</h1>
                        <div className="grid grid-cols-2 lg:grid-cols-4 gap-6">
                            <StatCard
                                title="Total Employees"
                                value={totalEmployees}
                                icon="Users"
                                accentColor={{ bg: 'bg-indigo-700/50', border: 'border-indigo-400', text: 'text-indigo-400' }}
                            />
                            <StatCard
                                title="Total Monthly Liability"
                                value={formatCurrency(totalSalaries)}
                                icon="DollarSign"
                                accentColor={{ bg: 'bg-green-700/50', border: 'border-green-400', text: 'text-green-400' }}
                            />
                            <StatCard
                                title="Last Paid Amount"
                                value={formatCurrency(lastMonthSalaryPaid)}
                                icon="CreditCard"
                                accentColor={{ bg: 'bg-yellow-700/50', border: 'border-yellow-400', text: 'text-yellow-400' }}
                            />
                            <StatCard
                                title="Active Clocked In"
                                value={activeEmployees}
                                icon="Clock"
                                accentColor={{ bg: 'bg-red-700/50', border: 'border-red-400', text: 'text-red-400' }}
                            />
                        </div>

                        <Card themeClass={themeClass}>
                            <h2 className={`text-2xl font-bold mb-4 ${themeClass.accent}`}>Recent Ledger Activity</h2>
                            <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-gray-700">
                                    <thead>
                                        <tr className={`${themeClass.sidebar}`}>
                                            <th className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${themeClass.textSecondary}`}>Date</th>
                                            <th className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${themeClass.textSecondary}`}>Employee</th>
                                            <th className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${themeClass.textSecondary}`}>Type</th>
                                            <th className={`px-6 py-3 text-left text-xs font-medium uppercase tracking-wider ${themeClass.textSecondary}`}>Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody className={`divide-y divide-gray-700 ${themeClass.card}`}>
                                        {ledgers.slice(0, 5).map((ledger) => (
                                            <tr key={ledger.id}>
                                                <td className={`px-6 py-4 whitespace-nowrap ${themeClass.text}`}>{formatDate(ledger.date)}</td>
                                                <td className={`px-6 py-4 whitespace-nowrap ${themeClass.text}`}>{ledger.employeeName}</td>
                                                <td className={`px-6 py-4 whitespace-nowrap ${themeClass.textSecondary}`}>{ledger.type}</td>
                                                <td className={`px-6 py-4 whitespace-nowrap font-semibold ${themeClass.accent}`}>{formatCurrency(ledger.amount)}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                                {ledgers.length === 0 && <p className={`text-center py-4 ${themeClass.textSecondary}`}>No recent ledger activity.</p>}
                            </div>
                            <div className="mt-4 flex justify-end">
                                <Button onClick={() => setActiveTab('Payroll/Ledger')} color="secondary">View All Ledger</Button>
                            </div>
                        </Card>
                    </div>
                );
            };

            // --- Settings Component ---
            const SettingsPanel = () => (
                <Card themeClass={themeClass}>
                    <h2 className={`text-2xl font-bold mb-4 ${themeClass.accent}`}>Application Settings</h2>
                    <div className="space-y-4">
                        <h3 className={`text-xl font-semibold ${themeClass.text}`}>Theme Selection</h3>
                        <div className="flex space-x-4">
                            {Object.keys(themes).map((key) => (
                                <div key={key} onClick={() => setTheme(key)} className={`p-4 rounded-xl cursor-pointer transition-all duration-200 shadow-lg border-4 ${
                                    theme === key ? 'border-blue-500 ring-4 ring-blue-500/50' : 'border-transparent hover:opacity-80'
                                }`} style={{ backgroundColor: themes[key].sidebar }}>
                                    <p className={`font-semibold capitalize ${themes[key].text}`}>{key.replace('-', ' ')}</p>
                                </div>
                            ))}
                        </div>

                        <div className="pt-4 border-t border-gray-700">
                            <h3 className={`text-xl font-semibold ${themeClass.text}`}>User Information</h3>
                            <p className={`${themeClass.textSecondary} mt-2 text-sm break-words`}>
                                Your unique User ID (for data storage): <span className={themeClass.accent}>{userId || 'Authenticating...'}</span>
                            </p>
                            <p className={`${themeClass.textSecondary} text-sm`}>
                                App ID: <span className={themeClass.accent}>{appId}</span>
                            </p>
                            <p className={`${themeClass.textSecondary} text-xs mt-2`}>
                                *Data is saved privately to this User ID using Firebase Firestore. Do not share your User ID.*
                            </p>
                        </div>
                    </div>
                </Card>
            );

            // --- Main Renderer ---
            const renderContent = () => {
                if (!isAuthReady) {
                    return (
                        <div className={`flex items-center justify-center h-screen ${themeClass.bg}`}>
                            <div className={`flex items-center p-4 rounded-xl shadow-xl ${themeClass.card}`}>
                                <svg className={`animate-spin h-5 w-5 mr-3 ${themeClass.accent}`} viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" /></svg>
                                <span className={themeClass.text}>Loading Vision App and Connecting to Database...</span>
                            </div>
                        </div>
                    );
                }

                switch (activeTab) {
                    case 'Dashboard':
                        return <Dashboard />;
                    case 'Employees':
                        return <EmployeeManagement />;
                    case 'Payroll/Ledger':
                        return <LedgerManagement />;
                    case 'Attendance':
                        return <AttendanceManagement />;
                    case 'Settings':
                        return <SettingsPanel />;
                    default:
                        return <Dashboard />;
                }
            };

            // --- Main Layout ---
            return (
                <div className={`min-h-screen flex ${themeClass.bg} ${themeClass.text}`}>
                    {/* Sidebar Navigation */}
                    <div className={`w-16 sm:w-64 flex-shrink-0 p-4 transition-all duration-300 ${themeClass.sidebar} shadow-2xl`}>
                        <h1 className={`text-xl font-extrabold mb-8 hidden sm:block ${themeClass.accent} whitespace-nowrap`}>VISION HR</h1>
                        <h1 className={`text-xl font-extrabold mb-8 block sm:hidden ${themeClass.accent} text-center`}>V</h1>
                        <div className="space-y-3">
                            <TabButton isActive={activeTab === 'Dashboard'} onClick={() => setActiveTab('Dashboard')} icon="LayoutDashboard" themeClass={themeClass}>Dashboard</TabButton>
                            <TabButton isActive={activeTab === 'Employees'} onClick={() => setActiveTab('Employees')} icon="Users" themeClass={themeClass}>Employees</TabButton>
                            <TabButton isActive={activeTab === 'Payroll/Ledger'} onClick={() => setActiveTab('Payroll/Ledger')} icon="CreditCard" themeClass={themeClass}>Payroll/Ledger</TabButton>
                            <TabButton isActive={activeTab === 'Attendance'} onClick={() => setActiveTab('Attendance')} icon="Clock" themeClass={themeClass}>Attendance</TabButton>
                            <TabButton isActive={activeTab === 'Settings'} onClick={() => setActiveTab('Settings')} icon="Settings" themeClass={themeClass}>Settings</TabButton>
                        </div>
                        <p className={`mt-8 text-xs text-center ${themeClass.textSecondary} hidden sm:block`}>User: {userId ? userId.substring(0, 8) + '...' : 'Guest'}</p>
                    </div>

                    {/* Main Content Area */}
                    <main className="flex-grow p-4 sm:p-8 overflow-y-auto">
                        {renderContent()}
                    </main>

                    {/* Modal for Alerts/Confirmation */}
                    <Modal isOpen={modal.isOpen} title={modal.type === 'Error' ? 'Error in Vision' : modal.type === 'ConfirmDelete' ? 'Confirm Action' : 'Success'} onClose={() => {
                        setModal({ isOpen: false, type: null, data: null });
                    }} themeClass={themeClass} modalData={modal}>
                        <p className={themeClass.text}>{modal.data?.message}</p>
                    </Modal>
                </div>
            );
        };

        // --- Render the App ---
        const container = document.getElementById('root');
        if (container) {
            const root = createRoot(container);
            root.render(<App />);
        }
    </script>
</body>
</html>

